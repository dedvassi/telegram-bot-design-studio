# Архитектура Telegram-бота для дизайн-студии

## Общая структура проекта

```
telegram_bot_project/
├── .env                      # Конфигурационный файл с токенами и настройками
├── main.py                   # Точка входа в приложение
├── requirements.txt          # Зависимости проекта
├── README.md                 # Документация по проекту
├── config/                   # Конфигурационные файлы
│   ├── config.py             # Основные настройки
│   └── whitelist.py          # Список разрешенных пользователей
├── core/                     # Ядро бота
│   ├── bot.py                # Основной класс бота
│   ├── session_manager.py    # Управление сессиями пользователей
│   └── auth.py               # Аутентификация пользователей
├── handlers/                 # Обработчики команд
│   ├── base_handler.py       # Базовый класс обработчика
│   ├── protocol_handler.py   # Обработчик команды /protocol
│   └── common_handlers.py    # Общие обработчики (старт, помощь и т.д.)
├── services/                 # Сервисы для работы с внешними API
│   ├── whisper_service.py    # Сервис для распознавания речи через Whisper
│   └── ollama_service.py     # Сервис для обработки текста через Ollama
├── utils/                    # Вспомогательные утилиты
│   ├── pdf_generator.py      # Генерация PDF-документов
│   ├── file_manager.py       # Управление файлами сессий
│   └── text_formatter.py     # Форматирование текста
└── templates/                # Шаблоны для PDF
    └── protocol_template.py  # Шаблон для протокола встречи
```

## Основные компоненты и их взаимодействие

### 1. Ядро бота (core/)

#### bot.py
- Инициализация бота с использованием pyTelegramBotAPI
- Регистрация обработчиков команд
- Запуск бота в асинхронном режиме

#### session_manager.py
- Создание и управление сессиями пользователей
- Хранение временных данных сессии
- Удаление сессий по завершении работы

#### auth.py
- Проверка пользователей по white list
- Ограничение доступа к функциям бота

### 2. Обработчики команд (handlers/)

#### protocol_handler.py
- Реализация сценария "Протокол встречи"
- Последовательный сбор метаданных
- Обработка голосовых сообщений
- Формирование итогового протокола

### 3. Сервисы (services/)

#### whisper_service.py
- Асинхронное взаимодействие с Whisper API
- Распознавание речи из голосовых сообщений

#### ollama_service.py
- Взаимодействие с Ollama (LLaMA3)
- Форматирование распознанного текста в Markdown

### 4. Утилиты (utils/)

#### pdf_generator.py
- Генерация PDF-документов с использованием fpdf2
- Поддержка брендирования (логотип, цвета, шрифты)
- Настраиваемое расположение текста

#### file_manager.py
- Создание директорий для сессий пользователей
- Управление временными файлами
- Очистка файлов по завершении сессии

## Процесс обработки команды /protocol

1. Пользователь отправляет команду /protocol
2. Проверка пользователя по white list
3. Создание новой сессии для пользователя
4. Последовательный сбор метаданных:
   - Название протокола
   - Дата
   - Номер проекта
   - Год договора
   - Тип проекта
   - Название ЖК/объекта
   - Имя заказчика
5. Запрос голосового сообщения с ключевыми вопросами
6. Обработка голосового сообщения:
   - Сохранение аудиофайла во временную директорию
   - Распознавание речи через Whisper
   - Форматирование текста через Ollama
7. Отображение результата и запрос подтверждения
8. Аналогичный процесс для принятия решений
9. Генерация PDF-документа:
   - Формирование шаблона с метаданными
   - Добавление блока вопросов
   - Добавление блока решений
   - Применение брендирования
10. Отправка PDF-документа пользователю
11. Удаление временных файлов и сессии

## Механизм хранения данных

- Каждая сессия хранится в отдельной директории, названной по user_id пользователя
- Временные файлы (аудио, промежуточные результаты) хранятся в директории сессии
- По завершении сессии директория полностью удаляется

## Асинхронность

- Использование асинхронных обработчиков для всех команд
- Асинхронное взаимодействие с внешними API (Whisper, Ollama)
- Параллельная обработка запросов от разных пользователей

## Безопасность

- Проверка пользователей по white list перед выполнением любых команд
- Изоляция данных разных пользователей в отдельных директориях
- Удаление всех временных данных по завершении сессии

## Масштабируемость

- Модульная архитектура позволяет легко добавлять новые команды
- Возможность расширения функциональности без изменения ядра бота
- Подготовка к возможному добавлению админ-панели в будущем
